// Copyright 2005-2014 Metrological
// All Rights Reserved.
(function(r,m,n,q){function v(c,e,f){c&&c.__defineGetter__(e,f)}function w(c){for(var e={},f;f=y.exec(c);)e[f[1]]=f[2];return e}var z=r.MAF=r.MAF={};m=m&&m.origin;var h=RegExp,A=Error,y=/\??(.*?)=([^\&]*)&?/gi,s=function(c){var e=[h(/^https?:\/\/10.(\d{1,3}).(\d{1,3}).(\d{1,3}):?\d*$/),h(/^https?:\/\/172.(1[6-9]|2[0-9]|3[0-1]).(\d{1,3}).(\d{1,3}):?\d*$/),h(/^https?:\/\/192.168.(\d{1,3}).(\d{1,3}):?\d*$/),h(/^https?:\/\/localhost:?\d*$/)];a:{if(c)for(var f=0;f<e.length;f++)if(e[f].test(c)){c=!0;break a}c=
!1}return c}(m),x=m&&h("/^https?://widgets.metrological.com$/").test(m),B=w(n.location.search)||{},C=function(c){for(var e=0;e<c.length;e++){var f=(c[e].src||"").split("?");if(1<f.length&&h("maf-room.(min.js|js)").test(f[0]))return w(f[1])}}(n.getElementsByTagName("script"))||{};z.Room=(s||x)&&function(){function c(a){this.events=this.events||{};if(!1!==a in this.events)for(var d=0;d<this.events[a].length;d++)this.events[a][d].apply(this,Array.prototype.slice.call(arguments,1))}function e(a){b&&1===
b.readyState&&b.send(JSON.stringify(a))}function f(){t=!0;p=0;for(var a in k){var d=k[a];d.user=q;c.call(d,"connected",{hash:a});var e=setInterval(function(){if(d.joined)return clearInterval(e);d.join()},3E3)}}function m(a){var d=JSON.parse(a.data),f=d.e;a=d.h;var b=d.u,h=d.d,l=k[a];if(l)switch(f){case "j":l.joined=!0;l.user||(l.user=b);g[a]=g[a]||[];-1===g[a].indexOf(b)&&(g[a].push(b),c.call(l,"joined",{hash:a,user:b,data:h}));l.user!==b&&e({e:"p",h:a,d:h});break;case "l":d=g[a].indexOf(b);-1<d&&
(g[a].splice(d,1),c.call(l,"hasleft",{hash:a,user:b,data:h}));break;case "d":-1!==g[a].indexOf(b)&&c.call(l,"data",{hash:a,user:b,data:h});break;case "p":-1===g[a].indexOf(b)&&(g[a].push(b),c.call(l,"joined",{hash:a,user:b,data:h}));break;case "e":c.call(l,"error",{hash:a,user:b,code:d.c})}}function h(){t=!1;p++;b&&(b.onopen=b.onmessage=b.onclose=null);b=null;for(var a in k){var d=k[a];d.joined=q;d.user=q;g[a].length=0}setTimeout(u,3E3*p)}function u(){var a;if(!(a=b))a:{try{a=new WebSocket("ws://ws"+
(s?"-sdk":"")+".metrological.com/");break a}catch(d){}a=void 0}(b=a)?(b.onopen=f,b.onmessage=m,b.onclose=h):(p++,setTimeout(u,3E3*p))}function n(a){a=a||B.hash||C.hash;if(!a)throw A("missing hash");if(k[a])return k[a];v(this,"hash",function(){return a});v(this,"connected",function(){return t});this.joined=!1;g[a]=[];k[a]=this}var p=0,t=!1,g={},k={},b;(s||x)&&u();n.prototype={join:function(a){e({e:"j",h:this.hash,d:a})},leave:function(a){this.user=q;e({e:"l",h:this.hash,d:a})},send:function(a){e({e:"d",
h:this.hash,d:a})},addEventListener:function(a,b){this.events=this.events||{};this.events[a]=this.events[a]||[];this.events[a].push(b)},removeEventListener:function(a,b){this.events=this.events||{};if(!1!==a in this.events){var c=this.events[a].indexOf(b);-1<c&&this.events[a].splice(c,1)}},destroy:function(){if(k){this.leave();for(var a in this.events||{})this.events[a]&&(this.events[a].length=0),delete this.events[a];delete this.events;g[this.hash]&&(g[this.hash].length=0);delete g[this.hash];delete k[this.hash]}}};
r.addEventListener("unload",function(){for(var a in k)k[a]&&k[a].destroy();k=g=null});return n}()})(window,location,document);