// Copyright 2005-2014 Metrological
// All Rights Reserved.
(function(r,m,n,q){function w(c,e,f){c&&c.__defineGetter__(e,f)}function x(c){for(var e={},f;f=z.exec(c);)e[f[1]]=f[2];return e}var A=r.MAF=r.MAF={};m=m&&m.origin;var k=RegExp,B=Error,z=/\??(.*?)=([^\&]*)&?/gi,s=function(c){var e=[k(/^https?:\/\/10.(\d{1,3}).(\d{1,3}).(\d{1,3}):?\d*$/),k(/^https?:\/\/172.(1[6-9]|2[0-9]|3[0-1]).(\d{1,3}).(\d{1,3}):?\d*$/),k(/^https?:\/\/192.168.(\d{1,3}).(\d{1,3}):?\d*$/),k(/^https?:\/\/localhost:?\d*$/)];a:{if(c)for(var f=0;f<e.length;f++)if(e[f].test(c)){c=!0;break a}c=
!1}return c}(m),y=m&&k("/^https?://widgets.metrological.com$/").test(m),C=x(n.location.search)||{},D=function(c){for(var e=0;e<c.length;e++){var f=(c[e].src||"").split("?");if(1<f.length&&k("maf-room.(min.js|js)").test(f[0]))return x(f[1])}}(n.getElementsByTagName("script"))||{};A.Room=(s||y)&&function(){function c(a){this.events=this.events||{};if(!1!==a in this.events)for(var d=0;d<this.events[a].length;d++)this.events[a][d].apply(this,Array.prototype.slice.call(arguments,1))}function e(a){b&&
1===b.readyState&&b.send(JSON.stringify(a))}function f(){t=!0;p=0;for(var a in g){var d=g[a];d.user=q;c.call(d,"connected",{hash:a});var e=setInterval(function(){if(d.joined)return clearInterval(e);d.join()},u)}}function m(a){var d=JSON.parse(a.data),f=d.e;a=d.h;var b=d.u,k=d.d,l=g[a];if(l)switch(f){case "j":l.joined=!0;l.user||(l.user=b);h[a]=h[a]||[];h[a].push(b);c.call(l,"joined",{hash:a,user:b,data:k});l.user!==b&&e({e:"p",h:a});break;case "l":d=h[a].indexOf(b);-1<d&&(h[a].splice(d,1),c.call(l,
"hasleft",{hash:a,user:b,data:k}));break;case "d":-1!==h[a].indexOf(b)&&c.call(l,"data",{hash:a,user:b,data:k});break;case "p":-1===h[a].indexOf(b)&&(h[a].push(b),c.call(l,"joined",{hash:a,user:b,data:k}));break;case "e":c.call(l,"error",{hash:a,user:b,err:d.c})}}function k(){t=!1;p++;b&&(b.onopen=b.onmessage=b.onclose=null);b=null;for(var a in g){var d=g[a];d.joined=q;d.user=q;h[a].length=0}setTimeout(v,u*p)}function v(){var a;if(!(a=b))a:{try{a=new WebSocket("ws://ws"+(s?"-sdk":"")+".metrological.com/");
break a}catch(d){}a=void 0}(b=a)?(b.onopen=f,b.onmessage=m,b.onclose=k):(p++,setTimeout(v,u*p))}function n(a){a=a||C.hash||D.hash;if(!a)throw B("missing hash");if(g[a])return g[a];w(this,"hash",function(){return a});w(this,"connected",function(){return t});this.joined=!1;h[a]=[];g[a]=this}var p=0,u=3E3,t=!1,h={},g={},b;(s||y)&&v();n.prototype={join:function(a){e({e:"j",h:this.hash,d:a})},leave:function(a){this.user=q;e({e:"l",h:this.hash,d:a})},send:function(a){e({e:"d",h:this.hash,d:a})},addEventListener:function(a,
b){this.events=this.events||{};this.events[a]=this.events[a]||[];this.events[a].push(b)},removeEventListener:function(a,b){this.events=this.events||{};if(!1!==a in this.events){var c=this.events[a].indexOf(b);-1<c&&this.events[a].splice(c,1)}},destroy:function(){if(g){this.leave();for(var a in this.events||{})this.events[a]&&(this.events[a].length=0),delete this.events[a];delete this.events;h[this.hash]&&(h[this.hash].length=0);delete h[this.hash];delete g[this.hash]}}};r.addEventListener("unload",
function(){for(var a in g)g[a]&&g[a].destroy();g=h=null});return n}()})(window,location,document);